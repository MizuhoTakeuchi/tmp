 # マップ合成アルゴリズム 詳細設計
 
 本設計は「doc/map_composer_requirement.md」の要件に基づき、2D点群マップを基準座標系（map1）へ統合するアルゴリズムの詳細を示す。
 
 ## 全体フロー
 1. 入力読み込み
    - `map_files: List[str]` のCSVを読み込み、各マップの点群 `Pi = {(x,y)}` を取得。
    - 隣接行列 `A (N×N)` をCSVから取得（無向隣接と想定）。
 2. クラスタリング（マップ内）
    - ノイズにロバストなDBSCAN相当（ε: 0.05〜0.2m, min_samples: 5〜10）で各マップの点群をクラスタに分割。
    - 目的：円型では小円ごと、L字では線分ごとに分離。
 3. 点群タイプ判別（クラスタ毎）
    - 円適合（Kasa法）で平均半径残差 r̄/R を評価（しきい値例: 0.02）。
    - しきい値未満→円型クラスタ。以上→線分/非円クラスタ。
    - 判別は多数決でマップ全体のタイプ（円型 or L字型）も推定。
 4. 特徴量抽出
    - 円型: クラスタ毎の円中心 `c=(cx,cy)`。
    - L字型: RANSACで2直線を検出→交点 `lc=(lcx,lcy)`, 線分長 `l1,l2`, 角度 `ldeg`。
 5. 隣接マップ間の対応付け
    - 円型: 中心点集合間の最近傍対応＋RANSACで外れ値除去。
    - L字型: (lc, l1, l2, ldeg) の近似一致で対応候補を生成。
 6. 初期変換推定（mapj→mapi）
    - 対応点集合から2D剛体変換（回転R, 並進t）を最小二乗（Horn/Procrustes）で推定。
 7. 参照座標系への連鎖合成
    - 隣接行列に沿ってBFSでmap1から伝播し、未知ノードの変換を合成。
8. グローバル微調整（ICP）
   - 全マップの対応点集合に対し同時最適化（点対点ICP）でR,tを微調整。
 
## ロバスト化の要点
- DBSCAN相当＋RANSACで外れ値耐性を確保。
- 円型/L字型の混在は無い前提を利用して、タイプ別の一致規準を簡潔化。
- 対応は二段階（最近傍→RANSAC確認）で誤対応を抑制。

## 実装メモ
- 依存はNumPy中心。クラスタリングは単純なε近傍連結で代替可能。
- 円適合は線形最小二乗（Kasa）を使用。
- 今回コミットでは「タイプ判別」までを実装対象とする。

## 特徴量対応付けと初期変換推定
- 円型: 各クラスタの円中心群を対応候補とし、2点RANSACで回転・並進を仮説化。最近傍一致でインライア数最大の仮説を選び、対応インライアでProcrustes（SVD）により (R,t) を再推定。
- L字型: クラスタ毎の交点 `lc` と2直線の方向ベクトルを用いる。
  - まず各クラスタ内で2本の主直線を抽出し、腕長が長い方を `line1` として正規化（ラインの順序を固定）。
  - 隣接マップ間では、なす角 `ldeg` が近いクラスタ対のみを候補（既定: ±5°）。
  - 1対のLから得られる2通りの回転候補（`line1→line1` または `line1→line2`）を列挙し、交点の位置一致と近傍点の整合でスコアリング。最良候補を初期変換とする。
  - 複数のLがある場合は、上記に加えて交点のインライア数で一貫性を評価。

## 変更履歴（L字特徴抽出の改善）
テストデータに対し、各マップで複数のL字を検出できるようにアルゴリズムを見直した。

- 以前: マップ全体を線分クラスタへ分割し、最長ペアを一つ選択してL字を構成していたため、重なりや縮退に弱く、検出数が不足した。
- 改善点:
  - 近傍クラスタ（ε連結）でまず「L字グループ」を抽出し、各グループ内で2本の直線を同定。
  - 直線同定は、(1) PCAで1本目を初期化、(2) 直交方向を2本目の初期値として、(3) 各点を2直線への最短距離で割当→PCAで再フィットを数回反復する2ライン分解で実施。
  - 交点が両線分の端点近傍（端点からの相対距離≤0.5）にあること、角度が`≥20°`、各腕長が閾値以上（0.2m）を満たすペアのみL字として採用。
  - 複数クラスタがある場合は、それぞれからL字を生成するため、map1=2個、map2=2個、map3=1個の検出要件を満たす。
  - パラメータ（推奨値）: `eps=0.12`, `min_samples=8`, `endpoint_frac_th=0.5`。
  - ライン順序の正規化: 腕長の長い直線を `line1` に固定し、異なるマップ間での向きの取り違いを抑制。
  
この見直しにより、線分が近接・部分重なりしていても安定に2本の主直線へ分解でき、L字の交点・角度・腕長の推定精度が向上した。
